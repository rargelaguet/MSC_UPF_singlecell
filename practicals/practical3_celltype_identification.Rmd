---
title: "Automated cell type identification"
author: "Ricard Argelaguet"
output: html_document
---

# Introduction

This vignette illustrates how to perform automated cell type identification using batch effect correction algorithms implemented in `Seurat`. It has been adapted from https://satijalab.org/seurat/articles/integration_mapping.html. 

# Load libraries

```{r, warning=FALSE, message=FALSE}
library(Seurat)
# library(ggplot2)
```

# Load the data

The data set consists of ~5kb cells of human pancreatic islet cells profiled by three different technologies

```{r}
seurat <- readRDS("/Users/ricard/data/not_used/pancreas_scrna/seurat_subset.rds")
table(seurat$tech)
```

## Prepare the data

Split the Seurat object into a list of Seurat objects, one for each technology
```{r, warning=FALSE, message=FALSE}
seurat.list <- SplitObject(seurat, split.by = "tech")
```

Perform the data normalization and feature selection for each batch separately.
```{r, warning=FALSE, message=FALSE}
for (i in 1:length(seurat.list)) {
  
  # Normalisation
  seurat.list[[i]] <- NormalizeData(
    object = seurat.list[[i]], 
    verbose = FALSE
  )
  
  # Feature selection
  seurat.list[[i]] <- FindVariableFeatures(
    object = seurat.list[[i]],
    selection.method = "vst",
    nfeatures = 2000, 
    verbose = FALSE
  )
}
```

Define the Smart-seq2 data set as the query and the CELseq2 data set as the reference
```{r}
seurat.query <- seurat.list$smartseq2
seurat.reference <- seurat.list$celseq2
```

Remove the celltype assignments for the query data 

```{r}
seurat.query$celltype <- NULL
```

# Data integration

In the previous practical we performed batch effect correction using the `IntegrateData` function. In this vignette we will perform a different type of data integraton by transferring the celltypes from the reference to the query data sets. The function we will use is called `TransferData`. Both functions share similarities (i.e. both procedures begin by identifying anchors between the two data sets), but there is an important distinction between data transfer and integration: in data transfer, Seurat does not correct or modify the expression data, it only transfers cellular attributes from one data set to the other (i.e. celltype assignments in this case)

## Find integration anchors

As in the previous vignette, the first part is to reduce the dimensionality of the data using PCA or CCA and then identify the "anchors" or the "mutual neighbours" between the different data sets (i.e. pairs of cells from each dataset that are contained within each other's neighbourhood)
```{r, warning=FALSE, message=FALSE}
anchors <- FindTransferAnchors(
  query = seurat.query, 
  reference = seurat.reference, 
  dims = 1:30
)
```

## Transfer cell type assignments

`TransferData` returns a matrix with predicted IDs and prediction scores
```{r}
celltype.predictions <- TransferData(
  anchorset = anchors, 
  refdata = seurat.reference$celltype, 
  dims = 1:30
  )
head(celltype.predictions)
```

Add celltype predictions to the query metadata.
```{r}
seurat.query <- AddMetaData(seurat.query, metadata = celltype.predictions[,c("predicted.id"), drop=F])
table(seurat.query@meta.data$predicted.id)
```

**(Q) Plot a UMAP of the query data and colour the cells by the predicted cell type assignemnts **

```{r}
seurat.query <- ScaleData(seurat.query)
seurat.query <- RunPCA(seurat.query, npcs = 30, verbose = FALSE)
seurat.query <- RunUMAP(seurat.query, reduction = "pca", dims = 1:30)
DimPlot(seurat.query, group.by ="predicted.id", reduction = "umap")
```

## Validation of cell type assignments

**(Q) Validate the cell type assignments by exploring the marker genes of the different cell types in the query and in the reference. Use the `FindMarker` genes function **

```{r}
```
